pipeline {
    agent {
        kubernetes {
            defaultContainer 'dotnet-sdk'
            yamlFile '_build/KubernetesPod.yaml'
        }
    }

    stages {
        stage('Build backend') {
            steps {
                sh 'dotnet build src/ChessWithActors.sln -c Release'
            }
        }

        stage('Test backend') {
            steps {
                sh 'dotnet test src/ChessWithActors.Backend.Tests/ChessWithActors.Backend.Tests.csproj -c Release --no-build --logger=trx'
            }
        }

        stage('Package backend') {
            steps {
                container('dotnet-sdk') {
                    sh 'dotnet publish src/ChessWithActors.Backend/ChessWithActors.Backend.csproj -c Release --no-build -o _build/out/backend'
                }
                container('docker') {
                    sh "docker build -f _build/Backend.Dockerfile -t aaronjamesford/chess-backend:${env.BRANCH_NAME}-${env.BUILD_NUMBER} ."
                }
            }
        }

        stage('Build ui') {
            steps {
                container('node') {
                    dir('src/chess-ui') {
                        sh 'npm install'
                        sh 'npm run build --prod --output-path=../../_build/out/ui'
                    }

                    sh 'ls /_build/out/ui'
                }
            }
        }

        stage('Package ui') {
            steps {
                container('docker') {
                    sh "docker build -f _build/UI.Dockerfile -t aaronjamesford/chess-ui:${env.BRANCH_NAME}-${env.BUILD_NUMBER} ."
                }
            }
        }

        stage('Publish backend') {
            steps {
                container('docker') {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                        sh "docker login -u ${env.USERNAME} -p ${env.PASSWORD}"
                        sh "docker push aaronjamesford/chess-backend:${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
                    }
                }
            }
        }

        stage('Publish ui') {
            steps {
                container('docker') {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                        sh "docker login -u ${env.USERNAME} -p ${env.PASSWORD}"
                        sh "docker push aaronjamesford/chess-ui:${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
                    }
                }
            }
        }
    }
    post {
        always{
            xunit (tools: [ MSTest(pattern: '**/*.trx') ], skipPublishingChecks: false)
        }
    }
}